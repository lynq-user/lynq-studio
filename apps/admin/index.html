<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lynq Studio â€” Admin</title>
  <style>
    :root {
      --bg: #0a0a0b;
      --surface: #141417;
      --surface2: #1c1c21;
      --border: #2a2a30;
      --text: #e5e5e7;
      --text2: #8b8b92;
      --accent: #6366f1;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #eab308;
      --blue: #3b82f6;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif; font-size: 14px; line-height: 1.5; }
    a { color: var(--accent); text-decoration: none; }

    /* Layout */
    .layout { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border); padding: 1.5rem 0; position: fixed; height: 100vh; overflow-y: auto; }
    .main { margin-left: 220px; flex: 1; padding: 2rem; }
    .logo { font-size: 1.2rem; font-weight: 700; padding: 0 1.25rem 1.5rem; color: #fff; display: flex; align-items: center; gap: 0.5rem; }
    .logo span { color: var(--accent); }

    /* Sidebar Nav */
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 1.25rem; color: var(--text2); cursor: pointer; transition: all 0.15s; font-size: 0.875rem; }
    .nav-item:hover { background: var(--surface2); color: var(--text); }
    .nav-item.active { color: #fff; background: var(--surface2); border-right: 2px solid var(--accent); }
    .nav-section { padding: 1rem 1.25rem 0.4rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text2); }

    /* Cards */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .stat-label { font-size: 0.75rem; color: var(--text2); text-transform: uppercase; letter-spacing: 0.05em; }
    .stat-value { font-size: 1.75rem; font-weight: 700; margin: 0.25rem 0; }
    .stat-sub { font-size: 0.8rem; color: var(--text2); }

    /* Table */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; }
    .card-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 0.6rem 0.75rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text2); border-bottom: 1px solid var(--border); }
    td { padding: 0.6rem 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
    tr:hover td { background: var(--surface2); }
    tr:last-child td { border-bottom: none; }

    /* Tags */
    .tag { display: inline-block; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .tag-green { background: rgba(34,197,94,0.15); color: var(--green); }
    .tag-red { background: rgba(239,68,68,0.15); color: var(--red); }
    .tag-yellow { background: rgba(234,179,8,0.15); color: var(--yellow); }
    .tag-blue { background: rgba(59,130,246,0.15); color: var(--blue); }

    /* Status dot */
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 0.4rem; }
    .dot-green { background: var(--green); }
    .dot-red { background: var(--red); }
    .dot-yellow { background: var(--yellow); }

    /* Live feed */
    .live-row { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

    /* Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .page-title { font-size: 1.5rem; font-weight: 700; }
    .page-subtitle { color: var(--text2); font-size: 0.875rem; }

    /* Refresh button */
    .btn { padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); cursor: pointer; font-size: 0.8rem; transition: all 0.15s; }
    .btn:hover { border-color: var(--accent); }
    .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.75rem; }

    /* Tabs */
    .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
    .tab { padding: 0.6rem 1rem; cursor: pointer; color: var(--text2); font-size: 0.875rem; border-bottom: 2px solid transparent; transition: all 0.15s; }
    .tab:hover { color: var(--text); }
    .tab.active { color: #fff; border-bottom-color: var(--accent); }

    /* Loading */
    .loading { text-align: center; padding: 3rem; color: var(--text2); }
    .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Empty state */
    .empty { text-align: center; padding: 2rem; color: var(--text2); }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main { margin-left: 0; padding: 1rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>

<div class="layout">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="logo"><span>â—†</span> Lynq Studio</div>

    <div class="nav-section">Genel</div>
    <div class="nav-item active" onclick="showPage('overview')">ğŸ“Š Genel BakÄ±ÅŸ</div>
    <div class="nav-item" onclick="showPage('live')">âš¡ CanlÄ± AkÄ±ÅŸ</div>

    <div class="nav-section">MÃ¼ÅŸteriler</div>
    <div class="nav-item" onclick="showPage('clients')">ğŸ¢ MÃ¼ÅŸteriler</div>

    <div class="nav-section">Debug</div>
    <div class="nav-item" onclick="showPage('inspector')">ğŸ” Event Inspector</div>
    <div class="nav-item" onclick="showPage('coverage')">ğŸ“‹ Parametre Doluluk</div>

    <div class="nav-section">YÃ¶netim</div>
    <div class="nav-item" onclick="showPage('usage')">ğŸ’° KullanÄ±m & Maliyet</div>
    <div class="nav-item" onclick="showPage('pricing')">ğŸ’ Teklif Hesapla</div>
    <div class="nav-item" onclick="showPage('system')">ğŸ”§ Sistem SaÄŸlÄ±ÄŸÄ±</div>
  </nav>

  <!-- Main Content -->
  <main class="main" id="content">
    <div class="loading"><div class="spinner"></div><br>YÃ¼kleniyor...</div>
  </main>
</div>

<script>
const API = 'https://lynq-studio-production.up.railway.app';
let autoRefresh = null;

// â”€â”€â”€ Fetch Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path) {
  const res = await fetch(API + path);
  return res.json();
}

function formatNum(n) {
  return parseInt(n || 0).toLocaleString('tr-TR');
}

function timeAgo(ts) {
  const diff = (Date.now() - new Date(ts).getTime()) / 1000;
  if (diff < 60) return Math.round(diff) + ' sn Ã¶nce';
  if (diff < 3600) return Math.round(diff / 60) + ' dk Ã¶nce';
  if (diff < 86400) return Math.round(diff / 3600) + ' saat Ã¶nce';
  return Math.round(diff / 86400) + ' gÃ¼n Ã¶nce';
}

function eventTypeTag(type) {
  const colors = {
    page_view: 'blue', session_start: 'green', scroll: 'yellow',
    custom: 'accent', purchase: 'green', add_to_cart: 'yellow',
    view_item: 'blue'
  };
  const c = colors[type] || 'blue';
  return `<span class="tag tag-${c}">${type}</span>`;
}

// â”€â”€â”€ Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showPage(page) {
  // Update nav
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  event?.target?.classList?.add('active');
  if (autoRefresh) { clearInterval(autoRefresh); autoRefresh = null; }

  const content = document.getElementById('content');
  content.innerHTML = '<div class="loading"><div class="spinner"></div><br>YÃ¼kleniyor...</div>';

  switch (page) {
    case 'overview': await renderOverview(); break;
    case 'live': await renderLive(); break;
    case 'clients': await renderClients(); break;
    case 'usage': await renderUsage(); break;
    case 'system': await renderSystem(); break;
    case 'pricing': renderPricing(); break;
    case 'inspector': await renderInspector(); break;
    case 'coverage': await renderCoverage(); break;
  }
}

// â”€â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderOverview() {
  const [clients, system] = await Promise.all([
    api('/api/admin/clients'),
    api('/api/admin/system')
  ]);

  const totals = clients.clients?.reduce((acc, c) => ({
    events: acc.events + parseInt(c.total_events || 0),
    pageviews: acc.pageviews + parseInt(c.pageviews || 0),
    visitors: acc.visitors + parseInt(c.unique_visitors || 0),
    last5min: acc.last5min + parseInt(c.events_last_5min || 0),
    last24h: acc.last24h + parseInt(c.events_last_24h || 0),
    visitors30min: acc.visitors30min + parseInt(c.visitors_last_30min || 0),
    events30min: acc.events30min + parseInt(c.events_last_30min || 0)
  }), { events: 0, pageviews: 0, visitors: 0, last5min: 0, last24h: 0, visitors30min: 0, events30min: 0 }) || {};

  const chStatus = system.clickhouse?.status === 'ok';
  const pgStatus = system.postgres?.status === 'ok';

  document.getElementById('content').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">Genel BakÄ±ÅŸ</div>
        <div class="page-subtitle">TÃ¼m mÃ¼ÅŸterilerin toplam durumu</div>
      </div>
      <button class="btn" onclick="showPage('overview')">â†» Yenile</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Aktif Åu An (5dk)</div>
        <div class="stat-value" style="color:var(--green)">${formatNum(totals.last5min)}</div>
        <div class="stat-sub">event / 5 dakika</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Aktif Åu An (30dk)</div>
        <div class="stat-value" style="color:var(--blue)">${formatNum(totals.visitors30min)}</div>
        <div class="stat-sub">${formatNum(totals.events30min)} event / 30 dakika</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Son 24 Saat</div>
        <div class="stat-value">${formatNum(totals.last24h)}</div>
        <div class="stat-sub">toplam event</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Toplam ZiyaretÃ§i</div>
        <div class="stat-value">${formatNum(totals.visitors)}</div>
        <div class="stat-sub">tekil kullanÄ±cÄ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Toplam Sayfa GÃ¶rÃ¼ntÃ¼leme</div>
        <div class="stat-value">${formatNum(totals.pageviews)}</div>
        <div class="stat-sub">page view</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">MÃ¼ÅŸteri SayÄ±sÄ±</div>
        <div class="stat-value">${clients.clients?.length || 0}</div>
        <div class="stat-sub">aktif website</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Sistem Durumu</div>
        <div class="stat-value" style="font-size:1rem">
          <span class="dot ${chStatus ? 'dot-green' : 'dot-red'}"></span>ClickHouse
          <span class="dot ${pgStatus ? 'dot-green' : 'dot-red'}" style="margin-left:0.5rem"></span>PostgreSQL
        </div>
        <div class="stat-sub">Buffer: ${system.buffer?.eventCount || 0} event bekliyor</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">MÃ¼ÅŸteriler</div>
      <table>
        <thead><tr><th>Website</th><th>Son 5dk</th><th>Son 24 Saat</th><th>Toplam Event</th><th>ZiyaretÃ§i</th><th>Son Event</th><th>Durum</th></tr></thead>
        <tbody>
          ${(clients.clients || []).map(c => `
            <tr style="cursor:pointer" onclick="showClientDetail('${c.website_id}')">
              <td><strong>${c.website_id}</strong></td>
              <td>${formatNum(c.events_last_5min)}</td>
              <td>${formatNum(c.events_last_24h)}</td>
              <td>${formatNum(c.total_events)}</td>
              <td>${formatNum(c.unique_visitors)}</td>
              <td>${timeAgo(c.last_event)}</td>
              <td>${parseInt(c.events_last_5min) > 0
                ? '<span class="tag tag-green">Aktif</span>'
                : '<span class="tag tag-yellow">Pasif</span>'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// â”€â”€â”€ Client Detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showClientDetail(websiteId) {
  const content = document.getElementById('content');
  content.innerHTML = '<div class="loading"><div class="spinner"></div><br>YÃ¼kleniyor...</div>';

  const data = await api('/api/admin/clients/' + websiteId + '?hours=24');

  content.innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">${websiteId}</div>
        <div class="page-subtitle">Son 24 saat detayÄ±</div>
      </div>
      <div>
        <button class="btn btn-sm" onclick="showClientDetail('${websiteId}')">â†» Yenile</button>
        <button class="btn btn-sm" onclick="showPage('clients')" style="margin-left:0.5rem">â† Geri</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Toplam Event</div>
        <div class="stat-value">${formatNum(data.stats?.total_events)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Sayfa GÃ¶rÃ¼ntÃ¼leme</div>
        <div class="stat-value">${formatNum(data.stats?.pageviews)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ZiyaretÃ§i</div>
        <div class="stat-value">${formatNum(data.stats?.unique_visitors)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Session</div>
        <div class="stat-value">${formatNum(data.stats?.sessions)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Custom Event</div>
        <div class="stat-value">${formatNum(data.stats?.custom_events)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Bad Events</div>
        <div class="stat-value" style="color:${data.bad_event_count > 0 ? 'var(--red)' : 'var(--green)'}">${data.bad_event_count}</div>
      </div>
    </div>

    ${data.bad_event_count > 0 ? `
    <div class="card" style="border-color:var(--red)">
      <div class="card-title" style="color:var(--red)">âš  HatalÄ± Event'ler</div>
      <table>
        <thead><tr><th>Zaman</th><th>Hata</th><th>Payload</th></tr></thead>
        <tbody>
          ${data.bad_events.map(e => `<tr><td>${e.ts}</td><td><span class="tag tag-red">${e.reason}</span></td><td style="font-size:0.75rem;color:var(--text2)">${e.payload_preview}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>` : ''}

    <div class="card">
      <div class="card-title">Saatlik DaÄŸÄ±lÄ±m</div>
      <table>
        <thead><tr><th>Saat</th><th>Event</th><th>ZiyaretÃ§i</th><th>Pageview</th></tr></thead>
        <tbody>
          ${(data.hourly_breakdown || []).map(h => `<tr><td>${h.saat}</td><td>${formatNum(h.events)}</td><td>${formatNum(h.visitors)}</td><td>${formatNum(h.pageviews)}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="card-title">Son Event'ler (Debug)</div>
      <table>
        <thead><tr><th>Zaman</th><th>Tip</th><th>Sayfa</th><th>Browser</th><th>Cihaz</th><th>KullanÄ±cÄ±</th></tr></thead>
        <tbody>
          ${(data.recent_events || []).map(e => `
            <tr class="live-row">
              <td style="white-space:nowrap">${e.ts}</td>
              <td>${eventTypeTag(e.event_type)}</td>
              <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis">${e.url_path}</td>
              <td>${e.browser}</td>
              <td>${e.device_type}</td>
              <td style="font-family:monospace;font-size:0.75rem">${e.client_short}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// â”€â”€â”€ Live Feed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderLive() {
  async function refresh() {
    const data = await api('/api/admin/live?limit=50');
    document.getElementById('live-body').innerHTML = (data.events || []).map(e => `
      <tr class="live-row">
        <td style="white-space:nowrap">${e.ts}</td>
        <td><span class="tag tag-blue">${e.website_id}</span></td>
        <td>${eventTypeTag(e.event_type)}</td>
        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${e.url_path}</td>
        <td>${e.browser} / ${e.os}</td>
        <td>${e.device_type}</td>
        <td>${e.referrer_domain || '-'}</td>
        <td style="font-family:monospace;font-size:0.75rem;cursor:pointer;color:var(--accent)" onclick="showUserJourney('${e.client_id}')" title="${e.client_id}">${e.client_short}</td>
      </tr>
    `).join('');
  }

  document.getElementById('content').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">âš¡ CanlÄ± Event AkÄ±ÅŸÄ±</div>
        <div class="page-subtitle">Son gelen event'ler (her 5 saniyede gÃ¼ncellenir)</div>
      </div>
      <button class="btn" onclick="renderLive()">â†» Yenile</button>
    </div>
    <div class="card">
      <table>
        <thead><tr><th>Zaman</th><th>MÃ¼ÅŸteri</th><th>Tip</th><th>Sayfa</th><th>Browser/OS</th><th>Cihaz</th><th>Kaynak</th><th>KullanÄ±cÄ±</th></tr></thead>
        <tbody id="live-body"><tr><td colspan="8" class="loading"><div class="spinner"></div></td></tr></tbody>
      </table>
    </div>
  `;

  await refresh();
  autoRefresh = setInterval(refresh, 5000);
}

// â”€â”€â”€ Clients List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderClients() {
  const data = await api('/api/admin/clients');

  document.getElementById('content').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">MÃ¼ÅŸteriler</div>
        <div class="page-subtitle">${data.clients?.length || 0} aktif website</div>
      </div>
      <button class="btn" onclick="showPage('clients')">â†» Yenile</button>
    </div>
    <div class="card">
      <table>
        <thead><tr><th>Website ID</th><th>Durum</th><th>Aktif (5dk)</th><th>Son 1 Saat</th><th>Son 24 Saat</th><th>Toplam</th><th>ZiyaretÃ§i</th><th>Session</th><th>Ä°lk Event</th><th>Son Event</th><th></th></tr></thead>
        <tbody>
          ${(data.clients || []).map(c => `
            <tr>
              <td><strong>${c.website_id}</strong></td>
              <td>${parseInt(c.events_last_5min) > 0 ? '<span class="dot dot-green"></span>Aktif' : '<span class="dot dot-yellow"></span>Pasif'}</td>
              <td>${formatNum(c.events_last_5min)}</td>
              <td>${formatNum(c.events_last_hour)}</td>
              <td>${formatNum(c.events_last_24h)}</td>
              <td>${formatNum(c.total_events)}</td>
              <td>${formatNum(c.unique_visitors)}</td>
              <td>${formatNum(c.sessions)}</td>
              <td>${timeAgo(c.first_event)}</td>
              <td>${timeAgo(c.last_event)}</td>
              <td><button class="btn btn-sm" onclick="showClientDetail('${c.website_id}')">Detay â†’</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// â”€â”€â”€ Usage & Cost â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderUsage() {
  const data = await api('/api/admin/usage');

  document.getElementById('content').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">KullanÄ±m & Maliyet</div>
        <div class="page-subtitle">MÃ¼ÅŸteri bazlÄ± kaynak tÃ¼ketimi</div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">ClickHouse</div>
        <div class="stat-value">$${data.cost_estimate?.clickhouse || 0}</div>
        <div class="stat-sub">/ay tahmini</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Railway (Server)</div>
        <div class="stat-value">$${data.cost_estimate?.railway || 0}</div>
        <div class="stat-sub">/ay</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Neon (PostgreSQL)</div>
        <div class="stat-value">$${data.cost_estimate?.neon || 0}</div>
        <div class="stat-sub">/ay</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Toplam Maliyet</div>
        <div class="stat-value" style="color:var(--accent)">$${data.cost_estimate?.total || 0}</div>
        <div class="stat-sub">/ay tahmini</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Depolama Boyutu</div>
      <table>
        <thead><tr><th>Tablo</th><th>Boyut</th><th>SatÄ±r SayÄ±sÄ±</th></tr></thead>
        <tbody>
          ${(data.storage || []).map(s => `<tr><td>${s.table}</td><td>${s.disk_size}</td><td>${formatNum(s.total_rows)}</td></tr>`).join('')}
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="card-title">AylÄ±k KullanÄ±m (MÃ¼ÅŸteri BazlÄ±)</div>
      <table>
        <thead><tr><th>Website</th><th>Ay</th><th>Event</th><th>ZiyaretÃ§i</th><th>Pageview</th><th>Purchase</th></tr></thead>
        <tbody>
          ${(data.monthly_usage || []).map(u => `
            <tr>
              <td><strong>${u.website_id}</strong></td>
              <td>${u.ay}</td>
              <td>${formatNum(u.events)}</td>
              <td>${formatNum(u.visitors)}</td>
              <td>${formatNum(u.pageviews)}</td>
              <td>${formatNum(u.purchases)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

// â”€â”€â”€ System Health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderSystem() {
  const data = await api('/api/admin/system');
  const mem = data.server?.memory || {};
  const mbUsed = Math.round((mem.heapUsed || 0) / 1024 / 1024);
  const mbTotal = Math.round((mem.heapTotal || 0) / 1024 / 1024);
  const uptimeH = Math.round((data.server?.uptime || 0) / 3600 * 10) / 10;

  document.getElementById('content').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">Sistem SaÄŸlÄ±ÄŸÄ±</div>
        <div class="page-subtitle">TÃ¼m bileÅŸenlerin durumu</div>
      </div>
      <button class="btn" onclick="showPage('system')">â†» Yenile</button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Server</div>
        <div class="stat-value" style="font-size:1.2rem"><span class="dot dot-green"></span> Ã‡alÄ±ÅŸÄ±yor</div>
        <div class="stat-sub">Uptime: ${uptimeH} saat | RAM: ${mbUsed}/${mbTotal} MB</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ClickHouse</div>
        <div class="stat-value" style="font-size:1.2rem"><span class="dot ${data.clickhouse?.status === 'ok' ? 'dot-green' : 'dot-red'}"></span> ${data.clickhouse?.status === 'ok' ? 'BaÄŸlÄ±' : 'Hata'}</div>
        <div class="stat-sub">${data.clickhouse?.tables || 0} tablo</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">PostgreSQL</div>
        <div class="stat-value" style="font-size:1.2rem"><span class="dot ${data.postgres?.status === 'ok' ? 'dot-green' : 'dot-red'}"></span> ${data.postgres?.status === 'ok' ? 'BaÄŸlÄ±' : 'Hata'}</div>
        <div class="stat-sub">${data.postgres?.websites || 0} website kayÄ±tlÄ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Buffer</div>
        <div class="stat-value" style="font-size:1.2rem">${data.buffer?.eventCount || 0} event</div>
        <div class="stat-sub">Raw: ${data.buffer?.rawEventCount || 0} | Bad: ${data.buffer?.badEventCount || 0}</div>
      </div>
    </div>

    ${data.bad_event_rate ? `
    <div class="card">
      <div class="card-title">Son 1 Saat â€” Hata OranÄ±</div>
      <div style="font-size:2rem;font-weight:700;color:${data.bad_event_rate.bad > 0 ? 'var(--red)' : 'var(--green)'}">
        ${data.bad_event_rate.good > 0 ? ((data.bad_event_rate.bad / data.bad_event_rate.good) * 100).toFixed(2) : 0}%
      </div>
      <div class="stat-sub">${data.bad_event_rate.bad} hatalÄ± / ${data.bad_event_rate.good} baÅŸarÄ±lÄ± event</div>
    </div>` : ''}
  `;
}

// â”€â”€â”€ Event Inspector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderInspector() {
  // Ã–nce client listesini al
  const clientsData = await api('/api/admin/clients');
  const clients = clientsData.clients || [];
  const defaultClient = clients[0]?.website_id || '';

  document.getElementById('content').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">ğŸ” Event Inspector</div>
        <div class="page-subtitle">Her event'in tÃ¼m parametrelerini detaylÄ± incele â€” dolu/boÅŸ alanlarÄ± gÃ¶r</div>
      </div>
    </div>

    <div class="card" style="padding:1rem;margin-bottom:1rem">
      <div style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap">
        <select id="ins-client" onchange="loadInspector()" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.4rem 0.75rem;border-radius:6px;font-size:0.85rem">
          ${clients.map(c => `<option value="${c.website_id}" ${c.website_id === defaultClient ? 'selected' : ''}>${c.website_id}</option>`).join('')}
        </select>
        <select id="ins-type" onchange="loadInspector()" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.4rem 0.75rem;border-radius:6px;font-size:0.85rem">
          <option value="">TÃ¼m Event Tipleri</option>
          <option value="page_view">page_view</option>
          <option value="session_start">session_start</option>
          <option value="scroll">scroll</option>
          <option value="custom">custom</option>
          <option value="view_item">view_item</option>
          <option value="add_to_cart">add_to_cart</option>
          <option value="purchase">purchase</option>
          <option value="view_item_list">view_item_list</option>
          <option value="begin_checkout">begin_checkout</option>
        </select>
        <input id="ins-clientid" placeholder="Client ID filtrele..." style="background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.4rem 0.75rem;border-radius:6px;font-size:0.85rem;width:200px" />
        <button class="btn btn-sm" onclick="loadInspector()">Filtrele</button>
      </div>
    </div>

    <div id="inspector-results"><div class="loading"><div class="spinner"></div></div></div>
  `;

  loadInspector();
}

async function loadInspector() {
  const client = document.getElementById('ins-client').value;
  const type = document.getElementById('ins-type').value;
  const clientId = document.getElementById('ins-clientid').value;

  let url = '/api/admin/event-detail?website_id=' + client + '&limit=30';
  if (type) url += '&event_type=' + type;
  if (clientId) url += '&client_id=' + clientId;

  const data = await api(url);
  const container = document.getElementById('inspector-results');

  if (!data.events || data.events.length === 0) {
    container.innerHTML = '<div class="empty">Filtrelerle eÅŸleÅŸen event bulunamadÄ±.</div>';
    return;
  }

  container.innerHTML = data.events.map((ev, i) => `
    <div class="card" style="margin-bottom:0.75rem">
      <div class="card-title" style="cursor:pointer" onclick="document.getElementById('ev-detail-${i}').style.display = document.getElementById('ev-detail-${i}').style.display === 'none' ? 'block' : 'none'">
        <div>
          ${eventTypeTag(ev.event_type)}
          ${ev.event_name ? '<span class="tag tag-blue" style="margin-left:4px">' + ev.event_name + '</span>' : ''}
          <span style="color:var(--text2);margin-left:8px;font-weight:400;font-size:0.8rem">${ev.url_path}</span>
        </div>
        <div style="display:flex;align-items:center;gap:1rem">
          <span style="font-size:0.75rem;color:var(--text2)">${ev.ts}</span>
          <span class="tag tag-green">${ev.filled_count} dolu</span>
          <span class="tag tag-red">${ev.empty_count} boÅŸ</span>
          <span style="font-size:0.85rem;color:var(--text2)">â–¼</span>
        </div>
      </div>

      <div id="ev-detail-${i}" style="display:${i === 0 ? 'block' : 'none'}">
        <div style="margin-bottom:0.75rem">
          <div style="font-size:0.7rem;text-transform:uppercase;color:var(--green);margin-bottom:0.4rem;letter-spacing:0.05em">âœ“ Dolu Parametreler (${ev.filled_count})</div>
          <table>
            <thead><tr><th style="width:200px">Parametre</th><th>DeÄŸer</th></tr></thead>
            <tbody>
              ${ev.filled_params.map(p => `
                <tr>
                  <td style="font-family:monospace;font-size:0.8rem;color:var(--accent)">${p.key}</td>
                  <td style="font-size:0.8rem;word-break:break-all">${
                    Array.isArray(p.value)
                      ? '<span style="color:var(--yellow)">[' + p.value.join(', ') + ']</span>'
                      : typeof p.value === 'object'
                        ? '<span style="color:var(--yellow)">' + JSON.stringify(p.value) + '</span>'
                        : p.value
                  }</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div>
          <div style="font-size:0.7rem;text-transform:uppercase;color:var(--red);margin-bottom:0.4rem;letter-spacing:0.05em">âœ— BoÅŸ Parametreler (${ev.empty_count})</div>
          <div style="display:flex;flex-wrap:wrap;gap:0.3rem">
            ${ev.empty_params.map(p => `<span style="font-family:monospace;font-size:0.7rem;padding:0.15rem 0.4rem;background:rgba(239,68,68,0.08);color:var(--text2);border-radius:3px">${p}</span>`).join('')}
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

// â”€â”€â”€ Parametre Doluluk Raporu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderCoverage() {
  const clientsData = await api('/api/admin/clients');
  const clients = clientsData.clients || [];
  const defaultClient = clients[0]?.website_id || '';

  document.getElementById('content').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">ğŸ“‹ Parametre Doluluk Raporu</div>
        <div class="page-subtitle">Event tipi baÅŸÄ±na hangi parametreler dolduruluyor â€” veri kalitesi kontrolÃ¼</div>
      </div>
    </div>

    <div class="card" style="padding:1rem;margin-bottom:1rem">
      <select id="cov-client" onchange="loadCoverage()" style="background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.4rem 0.75rem;border-radius:6px;font-size:0.85rem">
        ${clients.map(c => `<option value="${c.website_id}" ${c.website_id === defaultClient ? 'selected' : ''}>${c.website_id}</option>`).join('')}
      </select>
    </div>

    <div id="coverage-results"><div class="loading"><div class="spinner"></div></div></div>
  `;

  loadCoverage();
}

async function loadCoverage() {
  const client = document.getElementById('cov-client').value;
  const data = await api('/api/admin/param-coverage?website_id=' + client);
  const container = document.getElementById('coverage-results');

  if (!data.coverage || data.coverage.length === 0) {
    container.innerHTML = '<div class="empty">HenÃ¼z veri yok.</div>';
    return;
  }

  function pct(has, total) {
    if (!total || total === '0') return { text: '-', color: 'var(--text2)' };
    const p = Math.round((parseInt(has) / parseInt(total)) * 100);
    const color = p === 0 ? 'var(--text2)' : p < 30 ? 'var(--red)' : p < 70 ? 'var(--yellow)' : 'var(--green)';
    return { text: p + '%', color };
  }

  function cell(has, total) {
    const { text, color } = pct(has, total);
    return `<td style="text-align:center;color:${color};font-weight:600;font-size:0.8rem">${text}</td>`;
  }

  const params = [
    { key: 'has_url_path', label: 'url_path', cat: 'Sayfa' },
    { key: 'has_page_title', label: 'page_title', cat: 'Sayfa' },
    { key: 'has_client_id', label: 'client_id', cat: 'Kimlik' },
    { key: 'has_session_id', label: 'session_id', cat: 'Kimlik' },
    { key: 'has_referrer', label: 'referrer', cat: 'Kaynak' },
    { key: 'has_referrer_domain', label: 'referrer_domain', cat: 'Kaynak' },
    { key: 'has_utm_source', label: 'utm_source', cat: 'Kaynak' },
    { key: 'has_utm_medium', label: 'utm_medium', cat: 'Kaynak' },
    { key: 'has_country', label: 'country', cat: 'Geo' },
    { key: 'has_city', label: 'city', cat: 'Geo' },
    { key: 'has_browser', label: 'browser', cat: 'Cihaz' },
    { key: 'has_os', label: 'os', cat: 'Cihaz' },
    { key: 'has_device_type', label: 'device_type', cat: 'Cihaz' },
    { key: 'has_screen', label: 'screen', cat: 'Cihaz' },
    { key: 'has_language', label: 'language', cat: 'Cihaz' },
    { key: 'has_transaction_id', label: 'transaction_id', cat: 'E-Com' },
    { key: 'has_currency', label: 'currency', cat: 'E-Com' },
    { key: 'has_value', label: 'value', cat: 'E-Com' },
    { key: 'has_items', label: 'items[]', cat: 'E-Com' },
    { key: 'has_event_category', label: 'event_category', cat: 'Custom' },
    { key: 'has_event_label', label: 'event_label', cat: 'Custom' },
    { key: 'has_properties', label: 'properties', cat: 'Custom' },
    { key: 'has_scroll_depth', label: 'scroll_depth', cat: 'Interaction' },
    { key: 'has_search_term', label: 'search_term', cat: 'Interaction' }
  ];

  container.innerHTML = `
    <div class="card">
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Event Type</th>
              <th style="text-align:center">Toplam</th>
              ${params.map(p => `<th style="text-align:center;font-size:0.65rem;writing-mode:vertical-lr;height:100px;padding:0.3rem" title="${p.label}">${p.label}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${data.coverage.map(row => `
              <tr>
                <td>${eventTypeTag(row.event_type)}</td>
                <td style="text-align:center;font-weight:700">${formatNum(row.total)}</td>
                ${params.map(p => cell(row[p.key], row.total)).join('')}
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
      <div style="margin-top:1rem;font-size:0.75rem;color:var(--text2)">
        <span style="color:var(--green)">â– </span> 70%+ dolu &nbsp;
        <span style="color:var(--yellow)">â– </span> 30-70% dolu &nbsp;
        <span style="color:var(--red)">â– </span> <30% dolu &nbsp;
        <span style="color:var(--text2)">â– </span> 0% / yok
      </div>
    </div>
  `;
}

// â”€â”€â”€ MÃ¼ÅŸteri Teklif HesaplayÄ±cÄ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPricing() {
  document.getElementById('content').innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">ğŸ’ MÃ¼ÅŸteri Teklif HesaplayÄ±cÄ±</div>
        <div class="page-subtitle">MÃ¼ÅŸterinin trafiÄŸini gir â†’ fiyat, maliyet ve kÃ¢r otomatik hesaplansÄ±n</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:1.5rem">
      <div class="card-title">MÃ¼ÅŸteri Bilgileri</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-bottom:1rem">
        <div>
          <label style="font-size:0.75rem;color:var(--text2)">MÃ¼ÅŸteri / Marka AdÄ±</label>
          <input type="text" id="q-name" value="" placeholder="Poledoor" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.5rem;border-radius:6px;font-size:1rem;margin-top:0.25rem">
        </div>
        <div>
          <label style="font-size:0.75rem;color:var(--text2)">AylÄ±k Pageview (tahmini)</label>
          <input type="number" id="q-pageviews" value="100000" min="1000" step="10000" oninput="calcQuote()" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.5rem;border-radius:6px;font-size:1rem;margin-top:0.25rem">
        </div>
        <div>
          <label style="font-size:0.75rem;color:var(--text2)">SektÃ¶r</label>
          <select id="q-sector" onchange="calcQuote()" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.5rem;border-radius:6px;font-size:1rem;margin-top:0.25rem">
            <option value="ecommerce">E-Ticaret</option>
            <option value="saas">SaaS / YazÄ±lÄ±m</option>
            <option value="lead">Lead Gen / Kurumsal</option>
            <option value="media">Medya / Blog</option>
          </select>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem">
        <div>
          <label style="font-size:0.75rem;color:var(--text2)">E-Commerce Tracking</label>
          <select id="q-ecom" onchange="calcQuote()" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.5rem;border-radius:6px;font-size:1rem;margin-top:0.25rem">
            <option value="yes">Evet â€” tam e-commerce</option>
            <option value="basic">Temel â€” sadece purchase</option>
            <option value="no">HayÄ±r</option>
          </select>
        </div>
        <div>
          <label style="font-size:0.75rem;color:var(--text2)">Custom Event SayÄ±sÄ±</label>
          <select id="q-custom" onchange="calcQuote()" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.5rem;border-radius:6px;font-size:1rem;margin-top:0.25rem">
            <option value="0">Yok</option>
            <option value="5" selected>1-5 event</option>
            <option value="15">5-15 event</option>
            <option value="30">15+ event</option>
          </select>
        </div>
        <div>
          <label style="font-size:0.75rem;color:var(--text2)">KÃ¢r MarjÄ± Hedefi</label>
          <select id="q-margin" onchange="calcQuote()" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);padding:0.5rem;border-radius:6px;font-size:1rem;margin-top:0.25rem">
            <option value="85">%85 (agresif)</option>
            <option value="90" selected>%90 (standart)</option>
            <option value="93">%93 (premium)</option>
            <option value="95">%95 (yÃ¼ksek)</option>
          </select>
        </div>
      </div>
    </div>

    <div id="quote-result"></div>
  `;
  calcQuote();
}

function calcQuote() {
  var name = document.getElementById('q-name').value || 'MÃ¼ÅŸteri';
  var pageviews = parseInt(document.getElementById('q-pageviews').value) || 100000;
  var sector = document.getElementById('q-sector').value;
  var ecom = document.getElementById('q-ecom').value;
  var customEvents = parseInt(document.getElementById('q-custom').value) || 0;
  var marginTarget = parseInt(document.getElementById('q-margin').value) || 90;

  // Event Ã§arpanÄ± hesapla (pageview'a ek event'ler)
  var eventMultiplier = 1.3; // page_view + session_start
  if (ecom === 'yes') eventMultiplier += 0.5; // view_item, add_to_cart, purchase vs.
  if (ecom === 'basic') eventMultiplier += 0.2;
  eventMultiplier += (customEvents * 0.05);

  var totalEvents = Math.round(pageviews * eventMultiplier);

  // Maliyet hesapla
  var storageMB = (totalEvents * 0.00005); // 50 byte/event sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ
  var storageCost = storageMB * 0.0003; // $0.30/GB
  var computeCost = totalEvents * 0.000001; // sorgu maliyeti
  var serverCost = totalEvents < 500000 ? 0.50 : totalEvents < 2000000 ? 1.50 : totalEvents < 10000000 ? 5 : 15;
  var totalCost = storageCost + computeCost + serverCost + 0.50; // +$0.50 genel gider payÄ±

  // Fiyat hesapla (hedef marjdan)
  var price = totalCost / (1 - marginTarget / 100);
  // Yuvarlama â€” gÃ¼zel fiyat noktalarÄ±
  if (price < 25) price = 29;
  else if (price < 50) price = 49;
  else if (price < 70) price = 69;
  else if (price < 100) price = 99;
  else if (price < 130) price = 129;
  else if (price < 170) price = 149;
  else if (price < 250) price = 199;
  else if (price < 350) price = 299;
  else if (price < 450) price = 399;
  else if (price < 600) price = 499;
  else if (price < 800) price = 699;
  else price = Math.ceil(price / 100) * 100 - 1;

  var profit = price - totalCost;
  var actualMargin = ((profit / price) * 100).toFixed(1);

  document.getElementById('quote-result').innerHTML = `
    <div class="stats-grid">
      <div class="stat-card" style="border-color:var(--accent)">
        <div class="stat-label">Ã–nerilen AylÄ±k Fiyat</div>
        <div class="stat-value" style="color:var(--accent);font-size:2.5rem">$${price}</div>
        <div class="stat-sub">â‚º${Math.round(price * 36.5).toLocaleString('tr-TR')}/ay (kur: 36.5)</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Bizim Maliyetimiz</div>
        <div class="stat-value" style="color:var(--red)">$${totalCost.toFixed(2)}</div>
        <div class="stat-sub">Bu mÃ¼ÅŸteri iÃ§in aylÄ±k altyapÄ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Net KÃ¢r</div>
        <div class="stat-value" style="color:var(--green)">$${profit.toFixed(2)}</div>
        <div class="stat-sub">Marj: %${actualMargin}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">YÄ±llÄ±k KÃ¢r</div>
        <div class="stat-value" style="color:var(--green)">$${Math.round(profit * 12).toLocaleString()}</div>
        <div class="stat-sub">â‚º${Math.round(profit * 12 * 36.5).toLocaleString('tr-TR')}</div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <div class="card-title">ğŸ“‹ Teklif DetayÄ± â€” ${name}</div>
      <table>
        <thead><tr><th>Kalem</th><th>DeÄŸer</th><th>AÃ§Ä±klama</th></tr></thead>
        <tbody>
          <tr><td>AylÄ±k Pageview</td><td><strong>${pageviews.toLocaleString('tr-TR')}</strong></td><td>MÃ¼ÅŸterinin beyan ettiÄŸi</td></tr>
          <tr><td>Tahmini Toplam Event</td><td><strong>${totalEvents.toLocaleString('tr-TR')}</strong></td><td>Pageview Ã— ${eventMultiplier.toFixed(1)} (e-commerce + custom dahil)</td></tr>
          <tr><td>Depolama</td><td>${storageMB.toFixed(1)} MB/ay</td><td>ClickHouse sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ</td></tr>
          <tr><td>E-Commerce Tracking</td><td>${ecom === 'yes' ? 'âœ… Full (14 event tipi)' : ecom === 'basic' ? 'âš¡ Temel (purchase)' : 'âŒ Yok'}</td><td></td></tr>
          <tr><td>Custom Event</td><td>${customEvents > 0 ? customEvents + ' event' : 'Yok'}</td><td></td></tr>
          <tr style="border-top:2px solid var(--border)"><td><strong>AylÄ±k Fiyat</strong></td><td style="color:var(--accent);font-size:1.2rem"><strong>$${price}/ay</strong></td><td>â‚º${Math.round(price * 36.5).toLocaleString('tr-TR')}/ay</td></tr>
          <tr><td><strong>YÄ±llÄ±k (indirimli)</strong></td><td style="color:var(--green);font-size:1.2rem"><strong>$${Math.round(price * 10)}/yÄ±l</strong></td><td>2 ay bedava â€” â‚º${Math.round(price * 10 * 36.5).toLocaleString('tr-TR')}/yÄ±l</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card" style="margin-top:1rem">
      <div class="card-title">ğŸ“Š MÃ¼ÅŸteriye Sunulacak DeÄŸer</div>
      <table>
        <thead><tr><th>Ã–zellik</th><th>GA4 (Ãœcretsiz)</th><th>Lynq Studio</th></tr></thead>
        <tbody>
          <tr><td>Sampling</td><td style="color:var(--red)">500K+ event'te sampling</td><td style="color:var(--green)">Sampling yok â€” %100 gerÃ§ek veri</td></tr>
          <tr><td>Adblocker</td><td style="color:var(--red)">%25-40 veri kaybÄ±</td><td style="color:var(--green)">First-party â€” kayÄ±p yok</td></tr>
          <tr><td>Veri SahipliÄŸi</td><td style="color:var(--red)">Google'Ä±n sunucularÄ±</td><td style="color:var(--green)">Kendi sunucunuz</td></tr>
          <tr><td>Data Retention</td><td style="color:var(--red)">14 ay</td><td style="color:var(--green)">SÄ±nÄ±rsÄ±z (2 yÄ±l+ TTL)</td></tr>
          <tr><td>Raw Data EriÅŸimi</td><td style="color:var(--red)">BigQuery gerekli ($$$)</td><td style="color:var(--green)">SQL ile doÄŸrudan</td></tr>
          <tr><td>E-Commerce Detay</td><td style="color:var(--yellow)">Temel</td><td style="color:var(--green)">ÃœrÃ¼n bazlÄ± funnel, attribution</td></tr>
          <tr><td>Realtime</td><td style="color:var(--yellow)">SÄ±nÄ±rlÄ±</td><td style="color:var(--green)">5 saniye gecikme</td></tr>
          <tr><td>KVKK/GDPR</td><td style="color:var(--red)">Veri yurt dÄ±ÅŸÄ±nda</td><td style="color:var(--green)">EU sunucu, IP hash</td></tr>
        </tbody>
      </table>
    </div>
  `;
}

// â”€â”€â”€ User Journey â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function showUserJourney(clientId) {
  const content = document.getElementById('content');
  content.innerHTML = '<div class="loading"><div class="spinner"></div><br>KullanÄ±cÄ± yolculuÄŸu yÃ¼kleniyor...</div>';

  const data = await api('/api/admin/user/' + clientId + '?website_id=poledoor');
  const s = data.summary || {};

  content.innerHTML = `
    <div class="page-header">
      <div>
        <div class="page-title">ğŸ‘¤ KullanÄ±cÄ± YolculuÄŸu</div>
        <div class="page-subtitle" style="font-family:monospace">${clientId}</div>
      </div>
      <div>
        <button class="btn btn-sm" onclick="showUserJourney('${clientId}')">â†» Yenile</button>
        <button class="btn btn-sm" onclick="showPage('live')" style="margin-left:0.5rem">â† Geri</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Ä°lk GÃ¶rÃ¼lme</div>
        <div class="stat-value" style="font-size:1rem">${s.first_seen || '-'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Son Aktivite</div>
        <div class="stat-value" style="font-size:1rem">${s.last_seen || '-'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Toplam Event</div>
        <div class="stat-value">${formatNum(s.total_events)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Sayfa GÃ¶rÃ¼ntÃ¼leme</div>
        <div class="stat-value">${formatNum(s.pageviews)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Session SayÄ±sÄ±</div>
        <div class="stat-value">${formatNum(s.total_sessions)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">SatÄ±n Alma</div>
        <div class="stat-value" style="color:${parseInt(s.purchases) > 0 ? 'var(--green)' : 'var(--text2)'}">${formatNum(s.purchases)}</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:1rem">
      <div class="card-title">Cihaz Bilgisi</div>
      <div style="display:flex;gap:2rem;flex-wrap:wrap;font-size:0.85rem">
        <div><span style="color:var(--text2)">Browser:</span> ${s.browser || '-'}</div>
        <div><span style="color:var(--text2)">OS:</span> ${s.os || '-'}</div>
        <div><span style="color:var(--text2)">Cihaz:</span> ${s.device_type || '-'}</div>
        <div><span style="color:var(--text2)">Konum:</span> ${s.city || '-'}, ${s.country || '-'}</div>
        <div><span style="color:var(--text2)">Ekran:</span> ${s.screen || '-'}</div>
        <div><span style="color:var(--text2)">Dil:</span> ${s.language || '-'}</div>
      </div>
    </div>

    ${(data.sessions || []).map((sess, si) => `
      <div class="card" style="margin-bottom:0.75rem;border-left:3px solid var(--accent)">
        <div class="card-title">
          <div>
            Session ${data.sessions.length - si}
            ${sess.utm_source ? '<span class="tag tag-green" style="margin-left:8px">' + sess.utm_source + ' / ' + sess.utm_medium + '</span>' : ''}
            ${sess.referrer_domain ? '<span class="tag tag-blue" style="margin-left:4px">' + sess.referrer_domain + '</span>' : '<span class="tag tag-yellow" style="margin-left:4px">Direkt</span>'}
          </div>
          <div style="font-size:0.75rem;color:var(--text2)">
            ${sess.first_event} â†’ ${sess.last_event}
            <span style="margin-left:8px">${sess.events.length} event</span>
          </div>
        </div>

        <div style="position:relative;padding-left:24px">
          ${sess.events.map((ev, ei) => `
            <div style="position:relative;padding:0.4rem 0;border-left:2px solid var(--border);padding-left:16px;margin-left:0">
              <div style="position:absolute;left:-5px;top:0.55rem;width:8px;height:8px;border-radius:50%;background:${
                ev.event_type === 'purchase' ? 'var(--green)' :
                ev.event_type === 'add_to_cart' ? 'var(--yellow)' :
                ev.event_type === 'page_view' ? 'var(--blue)' :
                ev.event_type === 'session_start' ? 'var(--accent)' :
                'var(--text2)'
              }"></div>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  ${eventTypeTag(ev.event_type)}
                  ${ev.event_name && ev.event_name !== ev.event_type ? '<span style="color:var(--text2);margin-left:4px;font-size:0.8rem">' + ev.event_name + '</span>' : ''}
                  <span style="color:var(--text);margin-left:8px;font-size:0.85rem">${ev.url_path || ''}</span>
                  ${ev.page_title ? '<span style="color:var(--text2);margin-left:4px;font-size:0.75rem">(' + ev.page_title.substring(0, 50) + ')</span>' : ''}
                </div>
                <span style="font-size:0.7rem;color:var(--text2);white-space:nowrap">${ev.ts?.split(' ')[1] || ''}</span>
              </div>
              ${ev.item_names && ev.item_names.length > 0 ? '<div style="margin-top:0.3rem;font-size:0.75rem;color:var(--yellow)">ğŸ›’ ' + ev.item_names.join(', ') + (ev.value > 0 ? ' â€” â‚º' + parseFloat(ev.value).toLocaleString('tr-TR') : '') + '</div>' : ''}
              ${ev.transaction_id ? '<div style="margin-top:0.2rem;font-size:0.75rem;color:var(--green)">ğŸ’° SipariÅŸ: ' + ev.transaction_id + '</div>' : ''}
              ${ev.search_term ? '<div style="margin-top:0.2rem;font-size:0.75rem;color:var(--accent)">ğŸ” "' + ev.search_term + '"</div>' : ''}
              ${ev.scroll_depth > 0 ? '<div style="margin-top:0.2rem;font-size:0.75rem;color:var(--text2)">ğŸ“œ %' + ev.scroll_depth + ' scroll</div>' : ''}
              ${ev.click_text ? '<div style="margin-top:0.2rem;font-size:0.75rem;color:var(--text2)">ğŸ‘† ' + ev.click_text + '</div>' : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `).join('')}
  `;
}

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
showPage('overview');
</script>

</body>
</html>
